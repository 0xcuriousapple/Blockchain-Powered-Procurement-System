<html>

<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>GAIL</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
		integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	<link href="https://fonts.googleapis.com/css?family=Noto+Sans&display=swap" rel="stylesheet">
	<link href="styles/css/app.css" rel="stylesheet">
	<script src="scripts/web3.js/web3.min.js"></script>
	<script src="scripts/custom/qrcode.js"></script>
	<link
	rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
  />
  <style>
	.fa {
	  margin-right: 8px;
	}
  </style>

	<script type="text/javascript">
		var contract_address = "0x4EDB06f00FcA1CCCe632d769A9d936294D9F949C";
		var contract_abi = [
			{
				"inputs": [],
				"payable": false,
				"stateMutability": "nonpayable",
				"type": "constructor"
			},
			{
				"payable": true,
				"stateMutability": "payable",
				"type": "fallback"
			},
			{
				"constant": true,
				"inputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"name": "History",
				"outputs": [
					{
						"internalType": "address",
						"name": "holder",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "timestampArrived",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "timestampShipped",
						"type": "uint256"
					},
					{
						"internalType": "address",
						"name": "nextStop",
						"type": "address"
					},
					{
						"internalType": "address payable",
						"name": "vendor",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "quotation",
						"type": "uint256"
					},
					{
						"internalType": "bool",
						"name": "Status",
						"type": "bool"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"name": "PresentConditionOfItem",
				"outputs": [
					{
						"internalType": "address",
						"name": "holder",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "timestampArrived",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "timestampShipped",
						"type": "uint256"
					},
					{
						"internalType": "address",
						"name": "nextStop",
						"type": "address"
					},
					{
						"internalType": "address payable",
						"name": "vendor",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "quotation",
						"type": "uint256"
					},
					{
						"internalType": "bool",
						"name": "Status",
						"type": "bool"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": false,
				"inputs": [
					{
						"internalType": "address",
						"name": "_newholder",
						"type": "address"
					}
				],
				"name": "addHolder",
				"outputs": [],
				"payable": false,
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"constant": false,
				"inputs": [
					{
						"internalType": "uint256",
						"name": "_itemid",
						"type": "uint256"
					},
					{
						"internalType": "address payable",
						"name": "_vendor",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "_quotation",
						"type": "uint256"
					}
				],
				"name": "allotItemToVendor",
				"outputs": [],
				"payable": false,
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"constant": false,
				"inputs": [
					{
						"internalType": "address payable",
						"name": "_to",
						"type": "address"
					}
				],
				"name": "destroySmartContract",
				"outputs": [],
				"payable": false,
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [],
				"name": "getBalance",
				"outputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [
					{
						"internalType": "uint256",
						"name": "_itemid",
						"type": "uint256"
					}
				],
				"name": "getHistory",
				"outputs": [
					{
						"internalType": "address[]",
						"name": "",
						"type": "address[]"
					},
					{
						"internalType": "uint256[]",
						"name": "",
						"type": "uint256[]"
					},
					{
						"internalType": "uint256[]",
						"name": "",
						"type": "uint256[]"
					},
					{
						"internalType": "address[]",
						"name": "",
						"type": "address[]"
					},
					{
						"internalType": "address",
						"name": "payble",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					},
					{
						"internalType": "bool",
						"name": "",
						"type": "bool"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [
					{
						"internalType": "uint256",
						"name": "_itemid",
						"type": "uint256"
					}
				],
				"name": "getPresentStatus",
				"outputs": [
					{
						"internalType": "address",
						"name": "_holder",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "_timestampArrived",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "_timestampShipped",
						"type": "uint256"
					},
					{
						"internalType": "address",
						"name": "_nextStop",
						"type": "address"
					},
					{
						"internalType": "address payable",
						"name": "_vendor",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "_quotation",
						"type": "uint256"
					},
					{
						"internalType": "bool",
						"name": "_status",
						"type": "bool"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [
					{
						"internalType": "uint256",
						"name": "",
						"type": "uint256"
					}
				],
				"name": "listedItems",
				"outputs": [
					{
						"internalType": "bool",
						"name": "",
						"type": "bool"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": true,
				"inputs": [
					{
						"internalType": "address",
						"name": "",
						"type": "address"
					}
				],
				"name": "listedholders",
				"outputs": [
					{
						"internalType": "bool",
						"name": "",
						"type": "bool"
					}
				],
				"payable": false,
				"stateMutability": "view",
				"type": "function"
			},
			{
				"constant": false,
				"inputs": [
					{
						"internalType": "uint256",
						"name": "_itemid",
						"type": "uint256"
					},
					{
						"internalType": "address",
						"name": "_nextStop",
						"type": "address"
					}
				],
				"name": "shipNext",
				"outputs": [],
				"payable": false,
				"stateMutability": "nonpayable",
				"type": "function"
			},
			{
				"constant": false,
				"inputs": [
					{
						"internalType": "uint256",
						"name": "_itemid",
						"type": "uint256"
					}
				],
				"name": "updateStateOfArrivedItem",
				"outputs": [],
				"payable": false,
				"stateMutability": "nonpayable",
				"type": "function"
			}
		];

		if (typeof web3 !== "undefined") {
			web3 = new Web3(web3.currentProvider);
		} else {
			// set the provider you want from Web3.providers
			console.log("not detected");
			web3 = new Web3(
				new Web3.providers.HttpProvider("http://localhost:7545")
			);
		}

		var contract_instance;
		contract_instance = web3.eth.contract(contract_abi).at(contract_address);
		console.log(contract_instance);

		function updateState(_itemid) {
			console.log("Update State function");
			console.log(_itemid);
			var def = '<i class="fa fa-circle-o-notch fa-spin"></i>Mining';
        
		document.getElementById('submit-update').style.display = 'block';
		document.getElementById("submit-update").innerHTML = def;
        document.getElementById("Tracking-code").disabled = true;
			contract_instance.updateStateOfArrivedItem(_itemid, { from: web3.eth.accounts[0] }, function (error, result) {
				if (error) {

					console.error(error);
				} else {
					var txHash = result;
					console.log(txHash);
					callWhenMined(txHash, mined);
				}
			});
		}

		function mined() {
        console.log("Mined1");
        var def = '<i class="fa fa-thumbs-up" aria-hidden="true"></i>Done';
        document.getElementById("submit-update").innerHTML = def;
        document.getElementById("submit-update").style.backgroundColor =
          "green";
        

        console.log("Mined2");
      }
		function callWhenMined(txHash, callback) {
			web3.eth.getTransactionReceipt(txHash, function (error, rcpt) {
				if (error) {
					console.error(error);
				} else {
					if (rcpt == null) {
						setTimeout(function () {
							callWhenMined(txHash, callback);
						}, 500);
					} else {
						callback();
					}
				}
			})
		}

	</script>
	<script>
		function openQRCamera(node) {
			var reader = new FileReader();
			reader.onload = function () {
				node.value = "";
				qrcode.callback = function (res) {
					if (res instanceof Error) {
						alert("No QR code found. Please make sure the QR code is within the camera's frame and try again.");
					} else {
						node.parentNode.previousElementSibling.value = res;
						updateState(res);
					}
				};
				qrcode.decode(reader.result);
			};
			reader.readAsDataURL(node.files[0]);
		}
	</script>
</head>

<body>
	<div class="update">
		<div class="topbar">
			UPDATE
		</div>
		<div class="content">
			<input type=text id='Tracking-code' size=16 placeholder="Tracking Code" class=qrcode-text>
			<label class=qrcode-text-btn>
				<input type=file accept="image/*" capture=environment onchange="openQRCamera(this);" tabindex=-1 />
			</label><br /><br />
			<button class="btn btn-primary" id="submit-update" onclick="updateState()" style="display: none; margin-left: 47%;">SUBMIT</button>
		</div>
	</div>
	</div>
</body>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
	integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
	crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
	integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
	crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
	integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
	crossorigin="anonymous"></script>
<script src="scripts/custom/index.js"></script>
<script src="scripts/jquery/jquery.min.js"></script>

</html>